<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kakao Map Marker Example</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=cab40e28a8c1babd29615109dec388af"></script>
</head>
<body>
<div id="map" style="width:500px;height:400px;"></div>
<script>
    // Kakao Map JavaScript SDK를 사용하여 지도를 렌더링하는 함수
    function initMap() {
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };
        var map = new kakao.maps.Map(container, options);

        // 백엔드에서 모든 마커를 불러오기
        fetch('http://localhost:8080/api/map/markers', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer YOUR_JWT_TOKEN', // JWT 토큰 추가
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('네트워크 응답에 문제가 있습니다: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // data 형식에 맞춰 마커 위치 설정
                if (data.data && Array.isArray(data.data)) {
                    data.data.forEach(marker => {
                        var markerPosition = new kakao.maps.LatLng(marker.latitude, marker.longitude);
                        var mapMarker = new kakao.maps.Marker({
                            position: markerPosition
                        });
                        mapMarker.setMap(map);
                    });
                } else {
                    console.error('유효하지 않은 마커 데이터:', data);
                }
            })
            .catch(error => {
                console.error('fetch 작업 중 문제가 발생했습니다:', error);
            });

        // 사용자가 지도 클릭 시 새로운 마커 추가
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var clickedPosition = mouseEvent.latLng;

            // 새로운 마커를 지도에 생성
            var newMarker = new kakao.maps.Marker({
                position: clickedPosition
            });
            newMarker.setMap(map);

            // 백엔드에 마커 정보 저장
            fetch('http://localhost:8080/api/map/marker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer YOUR_JWT_TOKEN' // JWT 토큰 추가
                },
                body: JSON.stringify({
                    latitude: clickedPosition.getLat(),
                    longitude: clickedPosition.getLng(),
                    description: '사용자가 추가한 마커'
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답에 문제가 있습니다: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('마커가 성공적으로 저장되었습니다:', data);
                })
                .catch(error => {
                    console.error('마커 저장 중 오류 발생:', error);
                });
        });
    }

    // 지도를 초기화하는 함수 호출
    window.onload = initMap;
</script>
</body>
</html>
